<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Improving Search for Twitter Handles &middot; stf x clv
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="//public/css/poole.css">
  <link rel="stylesheet" href="//public/css/syntax.css">
  <link rel="stylesheet" href="//public/css/hyde.css">
  <link rel="stylesheet" href="//public/css/algolia.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="//public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="//public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-09">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="//">
          stf x clv
        </a>
      </h1>
      <p class="lead">My Knowledge Base on top of the popular <a href="http://hyde.getpoole.com/" target="_blank">Hyde theme</a> for <a href="http://jekyllrb.com" target="_blank">Jekyll</a>,with instant-search capabilities. Made by <a href="https://twitter.com/mdo" target="_blank">@mdo</a> and <a href="https://www.algolia.com/" target="_blank">Algolia</a></p>
    </div>

    <input type="text" class="algolia__input js-algolia__input" autocomplete="off" name="query" placeholder="Search in this site..." />

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="//">Home</a>

      

      
      
        
          
        
      
        
          
          <a class="sidebar-nav-item" href="//about/">About</a>
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

      <a class="sidebar-nav-item" href="https://github.com/algolia/algoliasearch-jekyll-hyde">GitHub project</a>
      <span class="sidebar-nav-item">Currently v2.1.0</span>
    </nav>

    <p>&copy; 2018. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="algolia__initial-content js-algolia__initial-content"><div class="post">
  <h1 class="post-title">Improving Search for Twitter Handles</h1>
  <span class="post-date">06 Jan 2014</span>
  <p>Hello Twitter,</p>

<p>I have been using your service for awhile, and I love it!</p>

<p>At first, I was skeptical about what you could offer: Broadcasting to all my
friends that I was eating a pizza, or taking a walk, is not really my cup of
tea. But 3 years ago I figured out what Twitter was really meant for and how
it could help me in a totally different way from what I first thought:</p>

<ul>
<li>sharing interesting articles,</li>
<li>checking if /replace by the service provider you want/ is down,</li>
<li>or catching up on HackerNews.</li>
</ul>

<p>More recently, I discovered you had a feature that could help me even more: I
can now ask for support by tweeting. Tweeting is often faster and more
productive than sending an email. You taught me to include the recipient&#39;s
Handle in my tweets, and your current Handle auto-completion implementation
works pretty well: but what if you could provide a <strong>better typo-tolerance and
ranking</strong>? (I&#39;m NOT speaking about your official OSX/iOS native clients and
its <a href="http://blog.algolia.com/why-autocomplete-in-twitter-on-mobile-sucks/">totally unusable auto-completion feature</a>... btw, could you explain me why it
is different from the one on your website?).</p>

<p>I have been leading a search-engine development team over the last 5 years and
I&#39;m now VP of engineering at Algolia. I am aware that considering my job, I
have kind of an &quot;expert&quot; point of view about search. But search has become so
essential that I am convinced it <strong>must</strong> be irreproachable. Did you know
that 1.7M+ people are currently following</p>

<p>expecting great things from your search-engine, Twitter :) Here is how I would
improve search for Twitter handles:</p>

<p>For example, it would be nice if I could find President
<a href="https://twitter.com/barackobama">@barackobama</a> with his last name:</p>

<p><a href="https://blog.algolia.com/wp-%0Acontent/uploads/2013/12/Screen-Shot-2013-12-23-at-11.40.09.png"><img src="/algoliasearch-jekyll-hyde/assets/Screen-Shot-2013-12-23-at-11.40.09-263x300.png" alt="Search for Twitter handles including @obama yields less-than-stellar
results."></a></p>

<p>Same for Justin:</p>

<p><a href="https://blog.algolia.com/wp-%0Acontent/uploads/2013/12/Screen-Shot-2013-12-23-at-11.42.01.png"><img src="/algoliasearch-jekyll-hyde/assets/Screen-Shot-2013-12-23-at-11.42.01-262x300.png" alt="Search for Twitter handles that could be Justin Bieber&#39;s yields less-than-
stellar results."></a></p>

<p>Typo-tolerance is now a must-have, especially because we&#39;re all using
smartphones and tablets:</p>

<p><a href="https://blog.algolia.com/wp-%0Acontent/uploads/2013/12/Screen-Shot-2013-12-23-at-11.38.19.png"><img src="/algoliasearch-jekyll-hyde/assets/Screen-Shot-2013-12-23-at-11.38.19-263x300.png" alt="Search for Twitter handles should have typo tolerance."></a></p>

<p>More and more handles are now prefixed/suffixed by &quot;official&quot;, which makes
finding <a href="https://twitter.com/officialadele">@OfficialAdele</a> just impossible:</p>

<p><a href="https://blog.algolia.com/wp-content/uploads/2013/12/Screen-Shot-2013-12-23-at-11.47.52.png"><img src="/algoliasearch-jekyll-hyde/assets/Screen-Shot-2013-12-23-at-11.47.52.png" alt="Search for Twitter handles that start with @official is broken."></a></p>

<p><strong>For sure we can improve it, let&#39;s code!</strong></p>

<p>First of all Twitter, I need your Handles database :)</p>

<ul>
<li>I used your <a href="https://dev.twitter.com/docs/streaming-apis">Streaming API</a> to crawl about 20M+ accounts in ~2 weeks: it&#39;s not blazing fast but I must admit it does the job (and it&#39;s free). That&#39;s about 5 lines of Ruby with <a href="https://github.com/tweetstream/tweetstream">TweetStream</a>, good job guys!</li>
<li>and <a href="https://github.com/bmc/daemonize">Daemonize</a> to create a bin/crawler executable.</li>
</ul>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#! /usr/bin/env ruby</span>

<span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;environment&#39;</span><span class="p">))</span>

<span class="n">daemon</span> <span class="o">=</span> <span class="no">TweetStream</span><span class="o">::</span><span class="no">Daemon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;crawler&#39;</span><span class="p">,</span> <span class="ss">:log_output</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
<span class="n">daemon</span><span class="o">.</span><span class="n">on_inited</span> <span class="k">do</span>
  <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">reconnect!</span>
  <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;log/stream.log&#39;</span><span class="p">),</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">daemon</span><span class="o">.</span><span class="n">on_error</span> <span class="k">do</span> <span class="o">|</span><span class="n">message</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;Error: </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>
<span class="n">daemon</span><span class="o">.</span><span class="n">sample</span> <span class="k">do</span> <span class="o">|</span><span class="n">status</span><span class="o">|</span>
  <span class="no">Handle</span><span class="o">.</span><span class="n">create_from_status</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p>For each new tweet you send to me, I store the author (name + screen<em>name +
description + followers</em>count) and all his/her user mentions.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Handle</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">create_from_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="no">Handle</span><span class="o">.</span><span class="n">find_or_initialize_by</span><span class="p">(</span><span class="ss">screen_name</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">screen_name</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="n">h</span><span class="o">.</span><span class="n">screen_name</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">new_record?</span>
    <span class="n">h</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span>
    <span class="n">h</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">description</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">255</span><span class="o">]</span>
    <span class="n">h</span><span class="o">.</span><span class="n">followers_count</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followers_count</span>
    <span class="n">h</span><span class="o">.</span><span class="n">updated_at</span> <span class="o">||=</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">now</span>
    <span class="n">h</span><span class="o">.</span><span class="n">save</span>
    <span class="n">h</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">create_from_status</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
    <span class="no">Handle</span><span class="o">.</span><span class="n">create_from_user</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">status</span><span class="o">.</span><span class="n">user_mentions</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">mention</span><span class="o">|</span>
      <span class="n">m</span> <span class="o">=</span> <span class="no">Handle</span><span class="o">.</span><span class="n">find_or_initialize_by</span><span class="p">(</span><span class="ss">screen_name</span><span class="p">:</span> <span class="n">mention</span><span class="o">.</span><span class="n">screen_name</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">updated_at</span> <span class="o">||=</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">now</span>
      <span class="n">m</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">mention</span><span class="o">.</span><span class="n">name</span>
      <span class="n">m</span><span class="o">.</span><span class="n">mentions_count</span> <span class="o">||=</span> <span class="mi">0</span>
      <span class="n">m</span><span class="o">.</span><span class="n">mentions_count</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">m</span><span class="o">.</span><span class="n">save</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre></div>
<p>And every minute, I re-index the last-updated accounts with a batch request
using <a href="https://github.com/algolia/algoliasearch-rails">algoliasearch-rails</a>,</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">every</span> <span class="mi">1</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="ss">roles</span><span class="p">:</span> <span class="o">[</span><span class="ss">:cron</span><span class="o">]</span> <span class="k">do</span>
  <span class="n">runner</span> <span class="s2">&quot;Handle.where(&#39;updated_at &gt;= ?&#39;, 1.minute.ago).reindex!&quot;</span>
<span class="k">end</span>
</code></pre></div>
<p>The result order is based on several criteria:</p>

<ul>
<li>the number of typos,</li>
<li>the matching attributes: the name/handle is more important than the description,</li>
<li>the proximity between matched words,</li>
<li>and the followers count (I also use the &quot;mentions count&quot; if my crawler didn&#39;t get the followers count yet).</li>
</ul>

<p>I could have improved the results by using the user&#39;s list of
followers/following but I was limited by your <a href="https://dev.twitter.com/docs/rate-limiting/1.1">Rate
Limits</a>. <strong>Instead, I chose to
emphasize your top-users </strong>(accounts having 10M+ followers).</p>

<p>Here is the configuration I used</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Handle</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>

  <span class="kp">include</span> <span class="no">AlgoliaSearch</span>
  <span class="n">algoliasearch</span> <span class="ss">per_environment</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">auto_index</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">auto_remove</span><span class="p">:</span> <span class="kp">false</span> <span class="k">do</span>
    <span class="c1"># add an extra score attribute</span>
    <span class="n">add_attribute</span> <span class="ss">:score</span>

    <span class="c1"># add an extra full_name attribute: screen_name + name</span>
    <span class="n">add_attribute</span> <span class="ss">:full_name</span>

    <span class="c1"># do not take `full_name`&#39;s words order into account, `full_name` is more important than `description`</span>
    <span class="n">attributesToIndex</span> <span class="o">[</span><span class="s1">&#39;unordered(full_name)&#39;</span><span class="p">,</span> <span class="ss">:description</span><span class="o">]</span>

    <span class="c1"># list of attributes to highlight</span>
    <span class="n">attributesToHighlight</span> <span class="o">[</span><span class="ss">:screen_name</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:description</span><span class="o">]</span>

    <span class="c1"># use followers_count OR mentions_count to sort results (last sort criteria)</span>
    <span class="n">customRanking</span> <span class="o">[</span><span class="s1">&#39;desc(score)&#39;</span><span class="o">]</span>

    <span class="c1"># @I_love_you</span>
    <span class="n">separatorsToIndex</span> <span class="s1">&#39;_&#39;</span>

    <span class="c1"># tag top-users</span>
    <span class="n">tags</span> <span class="k">do</span>
      <span class="n">followers_count</span> <span class="o">&gt;</span> <span class="mi">10000000</span> <span class="o">?</span> <span class="o">[</span><span class="s1">&#39;top&#39;</span><span class="o">]</span> <span class="p">:</span> <span class="o">[]</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">full_name</span>
    <span class="c1"># consider screen_name and name equal</span>
    <span class="c1"># the name should not match exact so we concatenate it with the screen_name</span>
    <span class="o">[</span><span class="n">screen_name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">screen_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="c1"># the custom score</span>
  <span class="k">def</span> <span class="nf">score</span>
    <span class="k">return</span> <span class="n">followers_count</span> <span class="k">if</span> <span class="n">followers_count</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">mentions_count</span> <span class="o">&lt;</span> <span class="mi">10</span>
      <span class="n">mentions_count</span>
    <span class="k">elsif</span> <span class="n">mentions_count</span> <span class="o">&lt;</span> <span class="mi">100</span>
      <span class="n">mentions_count</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="k">elsif</span> <span class="n">mentions_count</span> <span class="o">&lt;</span> <span class="mi">1000</span>
      <span class="n">mentions_count</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="k">else</span>
      <span class="n">mentions_count</span> <span class="o">*</span> <span class="mi">1000</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre></div>
<p>The user query is composed by 2 backend queries:</p>

<ul>
<li>the first one retrieves all matching top-users (could be replaced by a query targeting your followers/following only)</li>
<li>the second one the others.</li>
</ul>

<p><a href="http://twittersearch.algolia.io/"><strong>Try it for yourself</strong></a>, and enjoy
relevant and highlighted results after the first keystroke: <a href="http://twittersearch.algolia.io/">Twitter Handles
Search</a>.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="//2015/07/15/new-distributed-search-network-texas/">
            Welcome Texas!
            <small>15 Jul 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="//2015/06/15/when-solid-state-drives-are-not-that-solid/">
            When Solid State Drives are not that solid
            <small>15 Jun 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="//2015/05/28/we-just-raised-our-series-a-whats-next/">
            We just raised our Series A. What's next?
            <small>28 May 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>
</div>

      <div class="algolia__search-content js-algolia__search-content">
        <h1 class="page-title">Search</h1>
        <div class="posts algolia__results"></div>
      </div>
    </div>

  <script>
  window.ALGOLIA_CONFIG = {
    'applicationId': 'latency',
    'indexName': 'jekyll',
    'apiKey': '6be0576ff61c053d5f9a3225e2a90f76',
    'baseurl': '/'
  }
</script>
<script id="algolia__template" type="text/template">

  <div class="algolia__result">
    <a class="algolia__result-link" href="{{ full_url }}#algolia:{{ css_selector }}">{{{ _highlightResult.title.value }}}</a>
    {{#posted_at}}
    <div class="algolia__result-date">{{ posted_at_readable }}</div>
    {{/posted_at}}
    <div class="algolia__result-text">{{{ _highlightResult.text.value }}}</div>
  </div>

</script>
<script id="algolia__template--no-results" type="text/template">
  No results found.
</script>
<script src="//cdn.jsdelivr.net/jquery/2.1.4/jquery.min.js"></script>
<script src="//cdn.jsdelivr.net/algoliasearch/3.6.0/algoliasearch.min.js"></script>
<script src="//cdn.jsdelivr.net/algoliasearch.helper/2.1.0/algoliasearch.helper.min.js"></script>
<script src="//cdn.jsdelivr.net/hogan.js/3.0.2/hogan.min.js"></script>
<script src="//cdn.jsdelivr.net/momentjs/2.10.3/moment.min.js"></script>
<script src="//public/js/algolia.js"></script>

  </body>
</html>
